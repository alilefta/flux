
generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

generator zod {
  provider = "prisma-zod-generator"
}
datasource db {
  provider = "postgresql"
}

// ============================= Updates ==========================================
// Key Enhancements
// Implemented (Backwards Compatible)

// ChannelCategory - Organize channels into sections
// ChannelType.ANNOUNCEMENT - Read-only news channels
// FileAttachment - Separate table for multiple files
// MessageReaction - Emoji reactions (like Discord)
// Channel settings - isLocked, slowModeRate, topic, position
// Message threading - replyTo for threaded replies
// Pinned messages - pinned flag
// Bio field - User profiles
// AuditLog - Action logging for moderation


// ⏳ Commented (Post-MVP)

// ChannelReadStatus - Unread message tracking
// ServerRole - Custom roles with permissions
// Invite - Invite tracking and management

// ============================= CORE MODELS ======================================

// 1. PROFILE: The Master User Record (Synced with Clerk)
model Profile {
  id       String  @id @default(uuid())
  clerkId  String  @unique
  name     String
  imageUrl String? @db.Text
  email    String  @db.Text
  bio      String? @db.Text // ✅ User bio/status
  
  // Relations
  servers  Server[]  // Servers I created (Owned)
  members  Member[]  // Servers I joined (As a member)
  channels Channel[] // Channels I created

  conversationsInitiated Conversation[] @relation("MemberOne")
  conversationsReceived  Conversation[] @relation("MemberTwo")
  directMessages         DirectMessage[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 2. SERVER: The Workspace
model Server {
  id          String  @id @default(uuid())
  name        String
  imageUrl    String  @db.Text
  inviteCode  String  @unique
  description String? @db.Text // ✅ Server description
  memberCount Int     @default(1)

  profileId String
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // Relations
  members    Member[]
  channels   Channel[]
  categories ChannelCategory[] // ✅ Channel organization

  auditLog   AuditLog[]     // many audit records per server

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([profileId])
}

// 3. MEMBER: Links Profile to Server with Role
enum MemberRole {
  ADMIN
  MODERATOR
  GUEST
}

model Member {
  id   String     @id @default(uuid())
  role MemberRole @default(GUEST)

  profileId String
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  serverId String
  server   Server @relation(fields: [serverId], references: [id], onDelete: Cascade)

  // Relations
  messages Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([profileId, serverId]) // ✅ One membership per server
  @@index([profileId])
  @@index([serverId])
}

// ============================= CHANNELS ======================================

// 4. CHANNEL CATEGORY: Organize channels (Discord-style)
model ChannelCategory {
  id       String @id @default(uuid())
  name     String
  position Int    @default(0) // For drag-and-drop ordering

  serverId String
  server   Server @relation(fields: [serverId], references: [id], onDelete: Cascade)

  channels Channel[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serverId])
  @@index([position])
}

// 5. CHANNEL: The "Room"
enum ChannelType {
  TEXT
  AUDIO
  VIDEO
  ANNOUNCEMENT // ✅ Read-only news/updates channel
}

model Channel {
  id       String      @id @default(uuid())
  name     String
  type     ChannelType @default(TEXT)
  topic    String?     @db.Text // ✅ Channel description/topic
  position Int         @default(0) // ✅ Order within category

  profileId String
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  serverId String
  server   Server @relation(fields: [serverId], references: [id], onDelete: Cascade)

  // ✅ Category (optional - uncategorized channels allowed)
  categoryId String?
  category   ChannelCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Relations
  messages Message[]

  // ✅ Channel settings
  isDefault    Boolean @default(false) // "general" channel (cannot delete)
  isLocked     Boolean @default(false) // Read-only (ANNOUNCEMENT type)
  slowModeRate Int?    // ✅ Seconds between messages (optional rate limit)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([profileId])
  @@index([serverId])
  @@index([categoryId])
  @@index([position])
}

// ============================= MESSAGES ======================================

// 6. MESSAGE: Channel messages
model Message {
  id      String @id @default(uuid())
  content String @db.Text

  fileUrl String? @db.Text // ❌ Deprecated (backwards compat only)

  memberId String
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  channelId String
  channel   Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  // ✅ Message metadata
  deleted Boolean @default(false) // Soft delete
  edited  Boolean @default(false) // Show "edited" badge
  pinned  Boolean @default(false) // ✅ Pin important messages

  // ✅ Relationships
  attachments FileAttachment[] // Multiple files
  reactions   MessageReaction[] // ✅ Emoji reactions

  // ✅ Reply threading (optional - for V2)
  replyToId String?
  replyTo   Message?  @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies   Message[] @relation("MessageReplies")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([channelId])
  @@index([memberId])
  @@index([replyToId])
}

// 7. FILE ATTACHMENT: Multiple files per message
model FileAttachment {
  id   String @id @default(uuid())
  url  String @db.Text
  name String
  type String // image, pdf, video, text, code, etc.
  size Int?

  messageId String?
  message   Message? @relation(fields: [messageId], references: [id], onDelete: Cascade)

    // ✅ ADD DirectMessage Relation
  directMessageId String?
  directMessage   DirectMessage? @relation(fields: [directMessageId], references: [id], onDelete: Cascade)


  createdAt DateTime @default(now())

  @@index([messageId])
  @@index([directMessageId]) // Add index

}

// 8. MESSAGE REACTION: Emoji reactions (Discord-style)
model MessageReaction {
  id    String @id @default(uuid())
  emoji String // Emoji unicode or custom emoji ID

  messageId String
  message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

    // ✅ ADD DirectMessage Relation
  directMessageId String?
  directMessage   DirectMessage? @relation(fields: [directMessageId], references: [id], onDelete: Cascade)


  memberId String
  // Note: Not using Member relation to allow reactions from any profile
  profileId String // Who reacted

  createdAt DateTime @default(now())

  @@unique([messageId, profileId, emoji]) // One reaction per emoji per user
  @@index([messageId])
  @@index([profileId])
  @@index([directMessageId]) // Add index

}

// ============================= DIRECT MESSAGES ======================================

// 9. CONVERSATION: 1:1 DMs
model Conversation {
  id String @id @default(uuid())

  memberOneId String
  memberOne   Profile @relation("MemberOne", fields: [memberOneId], references: [id], onDelete: Cascade)

  memberTwoId String
  memberTwo   Profile @relation("MemberTwo", fields: [memberTwoId], references: [id], onDelete: Cascade)

  directMessages DirectMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([memberOneId, memberTwoId])
  @@index([memberTwoId])
}

// 10. DIRECT MESSAGE: DM content
model DirectMessage {
  id      String  @id @default(uuid())
  content String  @db.Text
  fileUrl String? @db.Text // ❌ Deprecated (backwards compat)

  memberId String
  member   Profile @relation(fields: [memberId], references: [id], onDelete: Cascade)

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // ✅ Message metadata
  deleted Boolean @default(false)
  edited  Boolean @default(false)
  pinned  Boolean @default(false) // ✅ Pin important messages


  // ✅ Add Relations
  attachments FileAttachment[]
  reactions   MessageReaction[]

  // Update Reply Relation if you want threading in DMs too
  replyToId   String?
  replyTo     DirectMessage?  @relation("ReplyTo", fields: [replyToId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies     DirectMessage[] @relation("ReplyTo")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([memberId])
  @@index([conversationId])
}

// ============================= OPTIONAL ENHANCEMENTS ======================================

// 11. CHANNEL READ STATUS: Track unread messages (Post-MVP)
// Uncomment when needed
/*
model ChannelReadStatus {
  id String @id @default(uuid())

  memberId String
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  channelId String
  channel   Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  lastReadMessageId String? // Last message they saw
  lastReadAt        DateTime @default(now())

  @@unique([memberId, channelId])
  @@index([memberId])
  @@index([channelId])
}
*/

// 12. SERVER ROLES: Custom roles with permissions (Post-MVP)
// More granular than ADMIN/MODERATOR/GUEST
/*
model ServerRole {
  id          String @id @default(uuid())
  name        String
  color       String? // Hex color for role
  position    Int     @default(0) // Role hierarchy
  permissions Json    // Bitfield of permissions

  serverId String
  server   Server @relation(fields: [serverId], references: [id], onDelete: Cascade)

  members Member[] // Members with this role

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serverId])
  @@index([position])
}
*/

// 13. INVITE: Track server invites (Post-MVP)
/*
model Invite {
  id         String   @id @default(uuid())
  code       String   @unique
  uses       Int      @default(0)
  maxUses    Int?     // Null = unlimited
  expiresAt  DateTime?

  serverId String
  server   Server @relation(fields: [serverId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   Profile @relation(fields: [createdById], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([serverId])
  @@index([code])
}
*/

// 14. AUDIT LOG: Track server actions (Post-MVP)

enum AuditLogAction {
  CHANNEL_CREATE
  CHANNEL_DELETE
  CHANNEL_UPDATE
  MEMBER_KICK
  MEMBER_BAN
  MEMBER_ROLE_UPDATE
  MESSAGE_DELETE
  SERVER_UPDATE
}

model AuditLog {
  id     String         @id @default(uuid())
  action AuditLogAction

  serverId String   
  server   Server @relation(fields: [serverId], references: [id], onDelete: Cascade)

  userId String // Who performed the action
  targetId String? // Who/what was affected
  metadata Json? // Additional context

  createdAt DateTime @default(now())

  @@index([serverId])
  @@index([createdAt])
}


